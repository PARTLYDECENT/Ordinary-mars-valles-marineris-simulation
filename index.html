<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mars Colony Command: Valles Marineris Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --critical-color: #ff6b6b; --success-color: #51cf66; --warning-color: #ffd43b;
            --info-color: #5c9cec; --panel-bg: rgba(25, 25, 40, 0.92); --border-color: #ff5555;
            --text-primary: #e0e0e0; --text-secondary: #b0b0b0; --active-tab: #ff5555;
        }
        body { font-family: 'Consolas', 'Courier New', monospace; background: linear-gradient(145deg, #3a0a0a, #1d0b0b); color: var(--text-primary); margin: 0; overflow: hidden; }
        #canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; cursor: crosshair; z-index: 1; }
        .tooltip { position: absolute; background-color: rgba(0,0,0,0.9); color: white; padding: 6px 12px; border-radius: 5px; font-size: 10px; pointer-events: none; display: none; border: 1px solid var(--border-color); z-index: 200; }
        #side-panel {
            position: fixed; top: 0; left: 0; width: 320px; height: 100vh; z-index: 100;
            background: var(--panel-bg); border-right: 2px solid var(--border-color);
            backdrop-filter: blur(12px); display: flex; flex-direction: column;
            transition: transform 0.4s ease-in-out;
        }
        #side-panel.collapsed { transform: translateX(-100%); }
        #panel-toggle {
            position: absolute; top: 50%; right: -25px; transform: translateY(-50%);
            width: 25px; height: 60px; background: var(--panel-bg); cursor: pointer;
            border: 2px solid var(--border-color); border-left: none;
            border-top-right-radius: 8px; border-bottom-right-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
            color: var(--border-color);
        }
        #side-panel.collapsed #panel-toggle { transform: translateY(-50%) rotate(180deg); }
        .tab-nav { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .tab-button { flex: 1; padding: 12px 0; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 10px; text-transform: uppercase; transition: all 0.2s ease; }
        .tab-button:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .tab-button.active { background: var(--active-tab); color: white; font-weight: bold; }
        .tab-content { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        h3 { font-size: 1.1em; font-weight: bold; margin-bottom: 12px; color: var(--active-tab); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .metric { display: flex; justify-content: space-between; margin: 6px 0; font-size: 12px; }
        .metric-label { color: var(--text-secondary); }
        .metric-value { color: var(--text-primary); font-weight: bold; }
        .progress-bar-container { background: rgba(0,0,0,0.4); border-radius: 4px; height: 12px; overflow: hidden; border: 1px solid #555; }
        .progress-bar { height: 100%; background: var(--success-color); transition: width 0.4s ease; }
        .progress-bar.warning { background: var(--warning-color); }
        .progress-bar.critical { background: var(--critical-color); }
        .btn { background: linear-gradient(45deg, #e05050, #b03030); border: 1px solid #c04040; color: white; padding: 10px 14px; font-size: 11px; border-radius: 5px; cursor: pointer; font-family: inherit; transition: all 0.3s ease; text-transform: uppercase; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn:hover:not(:disabled) { background: linear-gradient(45deg, #f06060, #c04040); border-color: #d05050; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .btn:disabled { background: #333 !important; border-color: #444 !important; color: #777 !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; }
        .console { font-size: 10px; line-height: 1.4; color: var(--text-secondary); height: calc(100vh - 120px); }
        .console > div { margin-bottom: 4px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .critical-text { color: var(--critical-color); font-weight: bold; animation: pulse 2s infinite; }
        .success-text { color: var(--success-color); font-weight: bold; }
        .warning-text { color: var(--warning-color); font-weight: bold; }
        .info-text { color: var(--info-color); }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="tooltip" class="tooltip"></div>

    <div id="side-panel">
        <div id="panel-toggle" onclick="togglePanel()">«</div>
        <div class="tab-nav">
            <button class="tab-button active" onclick="openTab('status')">Status</button>
            <button class="tab-button" onclick="openTab('resources')">Resources</button>
            <button class="tab-button" onclick="openTab('production')">Production</button>
            <button class="tab-button" onclick="openTab('build')">Build</button>
            <button class="tab-button" onclick="openTab('log')">Log</button>
        </div>
        <div class="tab-content">
            <div id="status-pane" class="tab-pane active">
                <h3>ENVIRONMENTAL STATUS</h3>
                <div class="metric"><span class="metric-label">Sol:</span><span id="sol" class="metric-value">1</span></div>
                <div class="metric"><span class="metric-label">Temperature:</span><span id="temp" class="metric-value">-62°C</span></div>
                <div class="metric"><span class="metric-label">Wind Speed:</span><span id="wind" class="metric-value">12 kph</span></div>
                <div class="metric"><span class="metric-label">Weather:</span><span id="weather-status" class="metric-value success-text">NOMINAL</span></div>
                <h3 class="mt-6">POWER GRID</h3>
                <div class="metric"><span class="metric-label">Solar Output:</span><span id="solar-output" class="metric-value">0 W</span></div>
                <div class="metric"><span class="metric-label">Consumption:</span><span id="total-consumption" class="metric-value">0 W</span></div>
                <div class="metric"><span class="metric-label">Battery:</span> <span id="battery-charge-value" class="metric-value"></span></div>
                <div class="progress-bar-container"><div id="battery-bar" class="progress-bar"></div></div>
                <h3 class="mt-6">MISSION OBJECTIVE</h3>
                <div class="text-xs mb-2">Construct 20 solar panels to secure the colony's power grid.</div>
                <div class="metric"><span class="metric-label">Solar Panels Built:</span><span id="mission-panels-progress" class="metric-value"></span></div>
                <div class="progress-bar-container"><div id="mission-panels-bar" class="progress-bar"></div></div>
            </div>
            <div id="resources-pane" class="tab-pane">
                <h3>RESOURCE INVENTORY</h3>
                <div class="metric"><span class="metric-label">Oxygen:</span><span id="oxygen" class="metric-value"></span></div>
                <div class="progress-bar-container"><div id="oxygen-bar" class="progress-bar"></div></div>
                <div class="metric"><span class="metric-label">Water:</span><span id="water" class="metric-value"></span></div>
                <div class="progress-bar-container"><div id="water-bar" class="progress-bar"></div></div>
                <div class="metric"><span class="metric-label">Regolith:</span><span id="regolith" class="metric-value"></span></div>
                <div class="metric"><span class="metric-label">Iron Ore:</span><span id="iron-ore" class="metric-value"></span></div>
                <div class="metric"><span class="metric-label">Iron Plates:</span><span id="iron-plates" class="metric-value"></span></div>
                <div class="metric"><span class="metric-label">Electronics:</span><span id="electronics" class="metric-value"></span></div>
            </div>
            <div id="production-pane" class="tab-pane">
                <h3>SYSTEM CONTROLS</h3>
                <button class="btn" onclick="advanceTime()">Advance Sol</button>
                <button class="btn" onclick="toggleStorm()">Toggle Storm</button>
                <button class="btn" onclick="deployRover()">Deploy Rover</button>
                <h3 class="mt-6">MANUFACTURING</h3>
                <button class="btn" onclick="interactWithStructure('refinery')">Refine Regolith (20R)</button>
                <button class="btn" onclick="interactWithStructure('arc_furnace')">Smelt Plates (8 Ore)</button>
                <button class="btn" onclick="interactWithStructure('fabricator')">Craft Electronics (2P, 2R)</button>
                <button class="btn" onclick="interactWithStructure('habitat_module', 'electrolysis')">Electrolysis (15W)</button>
            </div>
            <div id="build-pane" class="tab-pane">
                <h3>COLONY CONSTRUCTION</h3>
                <button id="build-panel-btn" class="btn" onclick="buildSolarPanel()">Build Solar Panel (5P, 3E)</button>
                <button id="upgrade-lifesupport-btn" class="btn" onclick="attemptUpgrade('improvedLifeSupport')">Upgrade Life Support (10P, 5E)</button>
                <button id="upgrade-battery-btn" class="btn" onclick="attemptUpgrade('batteryExpansion')">Expand Battery (20P, 10E)</button>
            </div>
            <div id="log-pane" class="tab-pane">
                 <h3>MISSION LOG</h3>
                 <div id="console" class="console"></div>
            </div>
        </div>
    </div>

    <script type="importmap">{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"}}</script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- CORE CONSTANTS & DEFINITIONS ---
        const SOL_DURATION_SECONDS = 60;
        const MISSION_TARGET_PANELS = 20;
        const CANYON_DEPTH = -40;
        const POWER_CONSUMPTION = {
            habitat_base: 50, electrolysis: 150, refinery_active: 200, arc_furnace_active: 350,
            fabricator_active: 100, rover_deploy: 50, life_support_upgrade: 25,
        };
        const STRUCTURE_DEFS = {
            habitat_module: { id: 1, pos: [0, 0], fallback: new THREE.CylinderGeometry(8, 10, 12, 16) },
            arc_furnace:    { id: 2, pos: [-25, 15], fallback: new THREE.BoxGeometry(8, 6, 6) },
            refinery:       { id: 3, pos: [20, 25], fallback: new THREE.CylinderGeometry(5, 6, 10, 12) },
            fabricator:     { id: 4, pos: [-15, -25], fallback: new THREE.BoxGeometry(6, 4, 8) },
            mining_rig:     { id: 5, pos: [30, -20], fallback: new THREE.CylinderGeometry(4, 5, 8, 8) },
            rover:          { id: 6, pos: [15, -10], fallback: new THREE.BoxGeometry(4, 2, 6) },
        };

        // --- SCENE & STATE ---
        let scene, camera, renderer, controls, clock, loader;
        let lightingSystem, solTimer = 0;
        let objects = { structures: {}, terrain: null, dust: null };
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        let gameState = {
            sol: 1, timeOfDay: 0.3, batteryCharge: 5000, batteryCapacity: 10000, solarPanelCount: 4,
            oxygen: 94, water: 78, regolith: 50, ironOre: 25, ironPlates: 10, electronics: 5,
            temp: -62, wind: 12, isStorm: false, roverDeployed: false,
            activeProcesses: {}, upgrades: { improvedLifeSupport: false, batteryExpansion: false },
        };

        // --- INITIALIZATION ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2a1810);
            scene.fog = new THREE.Fog(0x502828, 80, 500);

            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 15, 130);

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            
            clock = new THREE.Clock();
            loader = new GLTFLoader();

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, CANYON_DEPTH, 0);
            controls.minDistance = 10;
            controls.maxDistance = 300;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;

            setupLighting();
            createTerrain();
            createInitialStructures(); // This now relies on terrain existing
            createAtmosphere();
            
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('click', onMouseClick);
            window.addEventListener('resize', onWindowResize);
            
            log("Mars Colony Command Initialized.", "success");
            log(`Objective: Construct ${MISSION_TARGET_PANELS} Solar Panels.`, "warning");
            updateAllUI();
            animate();
        }

        function setupLighting() {
            scene.add(new THREE.AmbientLight(0x664433, 0.5));
            lightingSystem = new THREE.DirectionalLight(0xFFD4A3, 3.5);
            lightingSystem.position.set(150, 200, 100);
            lightingSystem.castShadow = true;
            lightingSystem.shadow.mapSize.set(2048, 2048);
            lightingSystem.shadow.camera.near = 10;
            lightingSystem.shadow.camera.far = 600;
            lightingSystem.shadow.camera.left = -300;
            lightingSystem.shadow.camera.right = 300;
            lightingSystem.shadow.camera.top = 300;
            lightingSystem.shadow.camera.bottom = -300;
            scene.add(lightingSystem);
        }

        function createTerrain() {
            const size = 800, segments = 250;
            const canyonFloorWidth = 100, canyonTopWidth = 250;
            const wallTransition = (canyonTopWidth - canyonFloorWidth) / 2;

            const geometry = new THREE.PlaneGeometry(size, size, segments, segments);
            const vertices = geometry.attributes.position;
            const simpleNoise = (x, y, scale, mag) => mag * Math.sin(x / scale + y / (scale/2));

            for (let i = 0; i < vertices.count; i++) {
                const x = vertices.getX(i);
                const pz = vertices.getY(i);
                const distFromCenter = Math.abs(x);
                let height = 0;

                if (distFromCenter < canyonFloorWidth / 2) {
                    height = CANYON_DEPTH;
                } else if (distFromCenter < canyonTopWidth / 2) {
                    const progress = (distFromCenter - canyonFloorWidth / 2) / wallTransition;
                    height = CANYON_DEPTH + (CANYON_DEPTH * -1) * Math.pow(progress, 1.8);
                }
                
                height += simpleNoise(x, pz, 30, 0.8) + simpleNoise(x, pz, 100, 1.5);
                vertices.setZ(i, height);
            }
            geometry.computeVertexNormals();
            const material = new THREE.MeshStandardMaterial({ color: 0x9A5833, roughness: 0.96 });
            objects.terrain = new THREE.Mesh(geometry, material);
            objects.terrain.rotation.x = -Math.PI / 2;
            objects.terrain.receiveShadow = true;
            objects.terrain.name = "terrain";
            scene.add(objects.terrain);

            // THIS IS THE CRITICAL FIX: Update the terrain's matrix before doing anything else
            objects.terrain.updateMatrixWorld(true);
        }
        
        function getSurfaceHeight(x, z) {
            raycaster.set(new THREE.Vector3(x, 200, z), new THREE.Vector3(0, -1, 0)); // Start ray higher up
            const intersects = raycaster.intersectObject(objects.terrain);
            if (intersects.length > 0) {
                return intersects[0].point.y;
            }
            console.error(`Raycast failed for position (${x}, ${z}). Using fallback depth.`);
            return CANYON_DEPTH;
        }

        function setupModel(model, name, x, z, yOffset = 0) {
            const groundY = getSurfaceHeight(x, z);
            model.position.set(x, groundY + yOffset, z);
            model.traverse(child => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            model.name = name;
            objects.structures[name] = model;
            scene.add(model);
        }
        
        function loadGLBModel(name, definition, material) {
            const [x, z] = definition.pos;
            loader.load(`struct${definition.id}.glb`, 
                (gltf) => setupModel(gltf.scene, name, x, z), 
                undefined, 
                () => {
                    log(`Fallback: creating procedural model for ${name}.`, 'warning');
                    const fallbackMesh = new THREE.Mesh(definition.fallback, material);
                    setupModel(fallbackMesh, name, x, z, definition.fallback.parameters.height / 2 || 0);
                }
            );
        }

        function createInitialStructures() {
            const genericMaterial = new THREE.MeshStandardMaterial({ color: 0xCCCCCC, roughness: 0.3, metalness: 0.7 });
            for (const name in STRUCTURE_DEFS) {
                loadGLBModel(name, STRUCTURE_DEFS[name], genericMaterial.clone());
            }
            for (let i = 0; i < gameState.solarPanelCount; i++) createSolarPanel(i);
        }

        function createSolarPanel(index) {
            const panelName = `solar_panel_${index}`;
            const panelGeom = new THREE.BoxGeometry(12, 0.3, 8);
            const panelMat = new THREE.MeshStandardMaterial({ color: 0x1a1a2e, roughness: 0.1, metalness: 0.9 });
            const panel = new THREE.Mesh(panelGeom, panelMat);
            const angle = (index / 10) * Math.PI;
            const radius = 35 + Math.floor(index / 10) * 15;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            setupModel(panel, panelName, x, z, 0.15);
        }

        function createAtmosphere() {
            const dustGeometry = new THREE.BufferGeometry();
            const dustPositions = new Float32Array(2500 * 3);
            for (let i = 0; i < 2500 * 3; i+=3) {
                dustPositions[i] = (Math.random() - 0.5) * 900;
                dustPositions[i + 1] = Math.random() * 180 + 15;
                dustPositions[i + 2] = (Math.random() - 0.5) * 900;
            }
            dustGeometry.setAttribute('position', new THREE.BufferAttribute(dustPositions, 3));
            const dustMaterial = new THREE.PointsMaterial({ color: 0xD2B48C, size: 1.0, transparent: true, opacity: 0.4, sizeAttenuation: true, depthWrite: false, blending: THREE.AdditiveBlending });
            objects.dust = new THREE.Points(dustGeometry, dustMaterial);
            scene.add(objects.dust);
        }

        // --- All other functions (game logic, UI, etc.) are included but omitted here for brevity ---
        //<editor-fold desc="Game Logic, UI, and Event Handlers">
        window.buildSolarPanel = function() {
            const cost = { ironPlates: 5, electronics: 3 };
            if (gameState.ironPlates >= cost.ironPlates && gameState.electronics >= cost.electronics) {
                gameState.ironPlates -= cost.ironPlates;
                gameState.electronics -= cost.electronics;
                createSolarPanel(gameState.solarPanelCount);
                gameState.solarPanelCount++;
                log(`Solar panel ${gameState.solarPanelCount} constructed.`, "success");
                updateAllUI();
                if (gameState.solarPanelCount >= MISSION_TARGET_PANELS) {
                    log("MISSION COMPLETE: Power grid secured! VICTORY.", "success");
                    setTimeout(() => window.location.href = 'win22.html', 2000);
                }
            } else { log("Insufficient resources for solar panel.", "critical"); }
        }

        function startProcess(key, duration, power, inputs, outputs) {
            if (gameState.activeProcesses[key]?.active) { log(`${key.replace(/_/g, ' ')} is already running.`, "warning"); return; }
            for (const res in inputs) {
                if (gameState[res] < inputs[res]) { log(`Insufficient ${res} for ${key}. Need ${inputs[res]}.`, "critical"); return; }
            }
            if (gameState.batteryCharge < power * 0.1) { log(`Insufficient power to start ${key}.`, "critical"); return; }
            for (const res in inputs) gameState[res] -= inputs[res];
            
            gameState.activeProcesses[key] = { active: true, timeLeft: duration, power, outputs };
            log(`${key.replace(/_/g, ' ')} process initiated.`, "info");
            updateAllUI();
        }

        window.interactWithStructure = (name, action) => {
            const interactions = {
                'refinery': () => startProcess('refinery', 15, POWER_CONSUMPTION.refinery_active, {regolith: 20}, {ironOre: 4, electronics: 2}),
                'arc_furnace': () => startProcess('arc_furnace', 12, POWER_CONSUMPTION.arc_furnace_active, {ironOre: 8}, {ironPlates: 3}),
                'fabricator': () => startProcess('fabricator', 10, POWER_CONSUMPTION.fabricator_active, {ironPlates: 2, regolith: 2}, {electronics: 1}),
                'habitat_module': () => { if (action === 'electrolysis') startProcess('electrolysis', 18, POWER_CONSUMPTION.electrolysis, {water: 15}, {oxygen: 8}); },
            };
            if(interactions[name]) interactions[name]();
        };

        window.advanceTime = function() {
            gameState.sol++;
            gameState.timeOfDay = 0.3; 
            const mod = gameState.upgrades.improvedLifeSupport ? 0.5 : 1;
            gameState.oxygen = Math.max(0, gameState.oxygen - (Math.random() * 3 + 1) * mod);
            gameState.water = Math.max(0, gameState.water - (Math.random() * 2 + 1) * mod);
            gameState.temp = -62 + (Math.random() - 0.5) * 20;
            gameState.wind = 12 + (Math.random() - 0.5) * 30;
            log(`Advancing to Sol ${gameState.sol}.`, "info");
            updateAllUI();
        };

        window.toggleStorm = () => {
            gameState.isStorm = !gameState.isStorm;
            log(gameState.isStorm ? "Dust storm incoming!" : "Weather clearing.", gameState.isStorm ? "warning" : "success");
        };

        window.deployRover = function() {
            if (gameState.roverDeployed) { log("Rover is already on a mission.", "warning"); return; }
            if (gameState.batteryCharge < POWER_CONSUMPTION.rover_deploy) { log("Insufficient power for rover deployment.", "critical"); return; }
            gameState.roverDeployed = true;
            gameState.batteryCharge -= POWER_CONSUMPTION.rover_deploy;
            log("Rover deployed for geological survey.", "info");
            setTimeout(() => {
                const foundOre = Math.floor(Math.random() * 20) + 10;
                const foundRegolith = Math.floor(Math.random() * 30) + 15;
                gameState.ironOre += foundOre;
                gameState.regolith += foundRegolith;
                log(`Rover returned: found ${foundOre}kg Ore and ${foundRegolith}kg Regolith.`, "success");
                gameState.roverDeployed = false;
                updateAllUI();
            }, 8000);
        };

        window.attemptUpgrade = function(type) {
            const costs = {
                improvedLifeSupport: { ironPlates: 10, electronics: 5 },
                batteryExpansion: { ironPlates: 20, electronics: 10 },
            };
            const cost = costs[type];
            const name = type.replace(/([A-Z])/g, ' $1').trim();
            if (gameState.upgrades[type]) { log(`${name} already installed.`, "info"); return; }
            if (gameState.ironPlates >= cost.ironPlates && gameState.electronics >= cost.electronics) {
                gameState.ironPlates -= cost.ironPlates;
                gameState.electronics -= cost.electronics;
                gameState.upgrades[type] = true;
                if (type === 'batteryExpansion') gameState.batteryCapacity += 10000;
                log(`Upgrade successful: ${name}.`, "success");
            } else { log(`Insufficient resources for ${name}.`, "critical"); }
            updateAllUI();
        };

        function animate() {
            requestAnimationFrame(animate);
            const deltaTime = clock.getDelta();
            gameState.timeOfDay = (gameState.timeOfDay + deltaTime / SOL_DURATION_SECONDS) % 1;
            updateLighting();
            updateProcesses(deltaTime);
            if (solTimer > 1) { updatePower(); solTimer = 0; }
            solTimer += deltaTime;
            objects.dust.material.opacity = gameState.isStorm ? 0.8 : 0.4;
            if(gameState.isStorm) objects.dust.rotation.y += deltaTime * 0.1;
            controls.update();
            renderer.render(scene, camera);
        }

        function updateLighting() {
            const sunAngle = gameState.timeOfDay * Math.PI * 2 - Math.PI / 1.5;
            const yPos = Math.sin(sunAngle) * 200 + 50;
            lightingSystem.position.x = Math.cos(sunAngle) * 250;
            lightingSystem.position.y = Math.max(20, yPos);
            lightingSystem.intensity = Math.max(0.1, yPos / 200) * 3.5 * (gameState.isStorm ? 0.3 : 1);
        }
        
        function updateProcesses(deltaTime) {
            let uiNeedsUpdate = false;
            for (const key in gameState.activeProcesses) {
                const p = gameState.activeProcesses[key];
                if (p.active) {
                    p.timeLeft -= deltaTime;
                    if (p.timeLeft <= 0) {
                        for (const res in p.outputs) gameState[res] = (gameState[res] || 0) + p.outputs[res];
                        log(`${key.replace(/_/g, ' ')} process complete.`, "success");
                        p.active = false;
                        uiNeedsUpdate = true;
                    }
                }
            }
            if (uiNeedsUpdate) updateAllUI();
        }

        function updatePower() {
            let consumption = POWER_CONSUMPTION.habitat_base + (gameState.upgrades.improvedLifeSupport ? POWER_CONSUMPTION.life_support_upgrade : 0);
            for (const key in gameState.activeProcesses) if(gameState.activeProcesses[key].active) consumption += gameState.activeProcesses[key].power;
            const sunAngle = gameState.timeOfDay * Math.PI * 2 - Math.PI / 1.5;
            const solarEfficiency = Math.max(0, Math.sin(sunAngle) + 0.5) * (gameState.isStorm ? 0.2 : 1);
            const generation = (80 * gameState.solarPanelCount) * solarEfficiency;
            gameState.batteryCharge = Math.max(0, Math.min(gameState.batteryCapacity, gameState.batteryCharge + (generation - consumption) * (1/60)));
            updateAllUI();
        }

        function updateAllUI() {
            document.getElementById('sol').textContent = String(gameState.sol).padStart(3, '0');
            document.getElementById('temp').textContent = `${Math.round(gameState.temp)}°C`;
            document.getElementById('wind').textContent = `${Math.round(gameState.wind * (gameState.isStorm ? 3 : 1))} kph`;
            const weatherEl = document.getElementById('weather-status');
            weatherEl.textContent = gameState.isStorm ? 'STORM' : 'NOMINAL';
            weatherEl.className = `metric-value ${gameState.isStorm ? 'critical-text' : 'success-text'}`;
            document.getElementById('solar-output').textContent = `${Math.round(gameState.batteryCharge < 1 ? 0 : (80 * gameState.solarPanelCount) * Math.max(0, Math.sin(gameState.timeOfDay * Math.PI * 2 - Math.PI/1.5) + 0.5) * (gameState.isStorm ? 0.2 : 1) )} W`;
            document.getElementById('total-consumption').textContent = `${Math.round(POWER_CONSUMPTION.habitat_base + Object.values(gameState.activeProcesses).reduce((acc, p) => acc + (p.active ? p.power : 0), 0))} W`;
            const batteryPercent = (gameState.batteryCharge / gameState.batteryCapacity) * 100;
            const batteryBar = document.getElementById('battery-bar');
            batteryBar.style.width = `${batteryPercent}%`;
            batteryBar.className = `progress-bar ${batteryPercent < 20 ? 'critical' : batteryPercent < 40 ? 'warning' : ''}`;
            document.getElementById('battery-charge-value').textContent = `${Math.round(gameState.batteryCharge)}/${gameState.batteryCapacity} Wh`;
            const missionPercent = (gameState.solarPanelCount / MISSION_TARGET_PANELS) * 100;
            document.getElementById('mission-panels-progress').textContent = `${gameState.solarPanelCount}/${MISSION_TARGET_PANELS}`;
            document.getElementById('mission-panels-bar').style.width = `${missionPercent}%`;
            ['oxygen', 'water'].forEach(res => {
                const val = Math.round(gameState[res]);
                document.getElementById(res).textContent = `${val}%`;
                const bar = document.getElementById(`${res}-bar`);
                bar.style.width = `${val}%`;
                bar.className = `progress-bar ${val < 20 ? 'critical' : val < 40 ? 'warning' : ''}`;
            });
            document.getElementById('regolith').textContent = `${gameState.regolith} kg`;
            document.getElementById('iron-ore').textContent = `${gameState.ironOre} kg`;
            document.getElementById('iron-plates').textContent = `${gameState.ironPlates} u`;
            document.getElementById('electronics').textContent = `${gameState.electronics} u`;
            document.getElementById('build-panel-btn').disabled = gameState.ironPlates < 5 || gameState.electronics < 3;
            document.getElementById('upgrade-lifesupport-btn').disabled = gameState.upgrades.improvedLifeSupport;
            document.getElementById('upgrade-battery-btn').disabled = gameState.upgrades.batteryExpansion;
        }

        function log(message, type = "info") {
            const consoleEl = document.getElementById('console');
            consoleEl.innerHTML += `<div><span class="text-gray-500">[Sol ${String(gameState.sol).padStart(3, '0')}]</span> <span class="${type}-text">${message}</span></div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        window.openTab = function(tabName) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${tabName}-pane`).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        window.togglePanel = function() {
            document.getElementById('side-panel').classList.toggle('collapsed');
        }
        function onMouseMove(event) {
            const tooltipEl = document.getElementById('tooltip');
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(Object.values(objects.structures));
            if (intersects.length > 0 && objects.structures[intersects[0].object.name]) {
                tooltipEl.style.display = 'block';
                tooltipEl.style.left = `${event.clientX + 10}px`;
                tooltipEl.style.top = `${event.clientY - 30}px`;
                tooltipEl.textContent = intersects[0].object.name.replace(/_/g, ' ').toUpperCase();
            } else {
                tooltipEl.style.display = 'none';
            }
        }
        function onMouseClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            if (intersects.length > 0 && intersects[0].object.name) {
                const name = intersects[0].object.name;
                if(STRUCTURE_DEFS[name]) interactWithStructure(name);
            }
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        //</editor-fold>

        init();
    </script>
</body>
</html>
